<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Redeem — Spin To Win</title>
<style>
:root{
  --bg1:#3b0b3b;
  --bg2:#120018;
  --gold:#ffbf00;
  --muted:#f3d8b6;
  --accent: linear-gradient(90deg,#ffd166,#ffbf00);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:
  radial-gradient(800px 400px at 10% 10%, rgba(255,191,0,0.06), transparent 6%),
  linear-gradient(180deg,var(--bg1),var(--bg2)); color:#fff}
.wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.card{width:100%;max-width:460px;border-radius:16px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.title{font-size:20px;font-weight:800}
.sub{color:var(--muted);font-size:13px}
.pointsBox{background:rgba(0,0,0,0.25);padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);font-weight:800}

/* conversion badge */
.conv{margin-top:12px;padding:10px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02);color:#ffd76a;font-weight:800;text-align:center}

/* form */
.form-row{margin-top:14px}
.label{font-size:13px;color:var(--muted);margin-bottom:6px}
.input {width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff;font-weight:700}

/* buttons */
.btn-row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
.btn{flex:1;padding:12px;border-radius:12px;border:none;cursor:pointer;font-weight:800}
.btn.gold{background:linear-gradient(90deg,#ffd166,#ffbf00);color:#04121a}
.btn.outline{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
.btn.full{width:100%;margin-top:12px;background:linear-gradient(90deg,#00d4ff,#8b4dff);color:#04121a;padding:12px 14px;border-radius:12px}

/* note */
.note{margin-top:12px;color:var(--muted);font-size:13px}

/* small */
.small{font-size:13px;color:var(--muted)}

@media(max-width:420px){ .card{padding:14px} .btn-row{gap:8px} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main">
      <div class="header">
        <div>
          <div class="title">Redeem</div>
          <div class="sub">Convert points to real money</div>
        </div>
        <div class="pointsBox">Points: <span id="pointsDisplay">0</span></div>
      </div>

      <div class="conv">Rate: <strong>100 points = ₹10</strong></div>

      <div class="form-row">
        <div class="label">Enter your UPI ID</div>
        <input id="upiInput" class="input" placeholder="example@upi" autocomplete="off" />
      </div>

      <div class="form-row">
        <div class="label">Quick Redeem</div>
        <div class="btn-row">
          <button class="btn gold" data-points="1000">Redeem 1000 pts</button>
          <button class="btn outline" data-points="2500">Redeem 2500 pts</button>
          <button class="btn outline" data-points="5000">Redeem 5000 pts</button>
        </div>
      </div>

      <button id="manualRedeem" class="btn full">Redeem Custom Amount</button>

      <div class="note" id="statusMsg">Requests are sent to <b>@sidh_9979</b> for manual verification and transfer.</div>

      <div style="display:flex;gap:8px;margin-top:14px">
        <button id="backBtn" class="btn outline">← Back</button>
        <button id="refreshBtn" class="btn outline">Refresh Points</button>
      </div>
    </div>
  </div>

<script>
/*
redeem.html
- Shows user points
- Sends a POST to BACKEND_BASE + /api/redeem with { userId, upi, points, target: "@sidh_9979" }
- Backend should handle actual sending/forwarding.
*/

const BACKEND_BASE = "https://spin-backend-yzlk.onrender.com"; // adjust if needed
const TARGET_ACCOUNT = "@sidh_9979"; // where redeem requests go

// UI refs
const pointsDisplay = document.getElementById('pointsDisplay');
const upiInput = document.getElementById('upiInput');
const statusMsg = document.getElementById('statusMsg');
const backBtn = document.getElementById('backBtn');
const refreshBtn = document.getElementById('refreshBtn');
const manualRedeemBtn = document.getElementById('manualRedeem');

let userId = localStorage.getItem('sw_user');
if (!userId) {
  userId = 'user-' + Math.random().toString(36).slice(2,10);
  localStorage.setItem('sw_user', userId);
}

// load points (from backend or localStorage fallback)
async function loadPoints(){
  try{
    const res = await fetch(BACKEND_BASE + '/api/user', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ userId })
    });
    const json = await res.json();
    if (json && json.user && json.user.points !== undefined) {
      setPoints(json.user.points);
    } else {
      setPoints(parseInt(localStorage.getItem('sw_points') || '0', 10));
    }
  }catch(e){
    setPoints(parseInt(localStorage.getItem('sw_points') || '0', 10));
  }
}
function setPoints(v){
  const pts = Math.max(0, parseInt(v||0,10));
  pointsDisplay.innerText = pts;
  localStorage.setItem('sw_points', pts);
}

// simple UPI validator (very permissive)
function isValidUpi(s){
  return typeof s === 'string' && s.length >= 5 && s.includes('@');
}

// send redeem request to backend
async function sendRedeemRequest(points){
  const upi = upiInput.value.trim();
  if (!isValidUpi(upi)){
    alert('Please enter a valid UPI ID (example: name@upi).');
    return;
  }
  const currentPoints = parseInt(pointsDisplay.innerText || '0', 10);
  if (currentPoints < points){
    alert('Insufficient points for this redemption.');
    return;
  }
  if (!confirm(`Confirm redeem ${points} points (≈ ₹${(points/100*10).toFixed(2)}) to UPI: ${upi}?`)) return;

  // Disable UI while processing
  manualRedeemBtn.disabled = true;
  refreshBtn.disabled = true;

  try{
    const payload = { userId, upi, points, target: TARGET_ACCOUNT };
    const res = await fetch(BACKEND_BASE + '/api/redeem', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await res.json();

    if (j && j.ok){
      // assume backend returns updated points or we deduct locally
      if (j.points !== undefined){
        setPoints(j.points);
      } else {
        setPoints(currentPoints - points);
      }
      alert('✅ Redeem request sent. Our team will process and notify you.');
      statusMsg.innerHTML = `Request sent to <b>${TARGET_ACCOUNT}</b>. Transaction will be reviewed.`;
    } else {
      console.warn('redeem failed', j);
      alert('Server failed to process redeem. Try again later.');
    }
  }catch(e){
    console.warn('network error', e);
    alert('Network error while sending redeem. Try again later.');
  }finally{
    manualRedeemBtn.disabled = false;
    refreshBtn.disabled = false;
  }
}

// quick button handlers
document.querySelectorAll('[data-points]').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    const pts = parseInt(btn.getAttribute('data-points'),10);
    sendRedeemRequest(pts);
  });
});

// manual redeem: prompt for a points value (must be one of allowed amounts)
manualRedeemBtn.addEventListener('click', ()=> {
  // For safety, ask user to pick one of allowed tiers
  const allowed = [1000,2500,5000];
  const selection = prompt('Enter points to redeem (allowed: 1000, 2500, 5000):', '1000');
  if (!selection) return;
  const pts = parseInt(selection.replace(/\D/g,''),10);
  if (!allowed.includes(pts)){
    alert('Invalid amount. Allowed: 1000, 2500, 5000.');
    return;
  }
  sendRedeemRequest(pts);
});

// back button
backBtn.addEventListener('click', ()=> {
  window.location.href = 'index.html';
});

// refresh points
refreshBtn.addEventListener('click', ()=> loadPoints());

// initial load
loadPoints();
</script>
</body>
</html>