
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spin Wheel</title>

<!-- Monetag SDK -->
<script src="//libtl.com/sdk.js" data-zone="10302036" data-sdk="show_10302036"></script>

<style>
:root{
  --bg1:#3b0b3b;
  --bg2:#120018;
  --gold:#ffbf00;
  --muted:#f3d8b6;
}
html,body{
  margin:0;height:100%;
  font-family:Inter,Arial,sans-serif;
  background:
    radial-gradient(900px 600px at 20% 10%, rgba(255,191,0,0.08), transparent 10%),
    linear-gradient(180deg,var(--bg1),var(--bg2));
  color:#fff;
}
.container{max-width:480px;margin:auto;padding:16px}

/* HEADER */
.header{display:flex;justify-content:space-between;align-items:center}
.backBtn{
  padding:10px 14px;border-radius:10px;
  background:transparent;border:1px solid rgba(255,255,255,.15);
  color:var(--muted);font-weight:700
}
.pointsBox{
  padding:10px 14px;border-radius:12px;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.15);
  font-weight:800
}

/* WHEEL */
.wheel-wrap{margin-top:20px;position:relative;display:flex;justify-content:center}
canvas{width:340px;height:340px}
.pointer{
  position:absolute;top:-6px;
  width:0;height:0;
  border-left:14px solid transparent;
  border-right:14px solid transparent;
  border-bottom:26px solid red;
}

/* BUTTONS */
.controls{margin-top:20px;display:flex;gap:12px}
.spinBtn{
  padding:14px 22px;border-radius:14px;
  border:none;font-weight:800;
  background:linear-gradient(90deg,#ffd166,#ffbf00);
  color:#3a2b00
}
.adBtn{
  padding:14px 18px;border-radius:14px;
  background:transparent;
  border:1px solid rgba(255,255,255,.15);
  color:var(--muted);font-weight:700
}
.info{margin-top:8px;font-size:13px;color:var(--muted)}

/* TELEGRAM */
.telegram-btn{
  position:fixed;right:18px;bottom:18px;
  width:64px;height:64px;border-radius:50%;
  box-shadow:0 8px 20px rgba(0,0,0,.5);
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <button class="backBtn" onclick="location.href='index.html'">‚Üê Back</button>
    <div class="pointsBox">Points: <span id="points">0</span></div>
  </div>

  <div class="wheel-wrap">
    <div class="pointer"></div>
    <canvas id="wheel" width="600" height="600"></canvas>
  </div>

  <div class="controls">
    <button class="spinBtn" id="spinBtn">SPIN</button>
    <button class="adBtn" id="adBtn">üé• Watch Ad</button>
  </div>

  <div class="info">Free spins: <b id="freeSpins">0</b></div>
</div>

<img src="https://files.catbox.moe/a3kksw.png" class="telegram-btn"
onclick="window.open('https://t.me/Spinwheel25channel','_blank')">

<script>
/* ================= CONFIG ================= */
const BACKEND = "https://spin-backend-yzlk.onrender.com";
let userId = localStorage.getItem("sw_uid") || ("u_" + Math.random().toString(36).slice(2));
localStorage.setItem("sw_uid", userId);

/* ================= GAME STATE ================= */
let points = 0;
let freeSpins = 0;
let angle = 0;
let spinning = false;

/* ================= SEGMENTS ================= */
const segments = [
  { label:"JACKPOT", value:200, weight:1 },
  { label:"TRY AGAIN", value:0, weight:20 },
  { label:"30", value:30, weight:16 },
  { label:"50", value:50, weight:12 },
  { label:"TRY AGAIN", value:0, weight:20 },
  { label:"FREE SPIN", value:"free", weight:10 },
  { label:"MINI", value:30, weight:15 },
  { label:"MEGA", value:100, weight:2 }
];

const colors = ["#e74c3c","#bdc3c7","#2ecc71","#f1c40f",
                "#95a5a6","#9b59b6","#3498db","#f39c12"];

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const cx = canvas.width/2, cy = canvas.height/2;
const radius = canvas.width/2 - 20;

/* ================= DRAW ================= */
function drawWheel(){
  const arc = 2*Math.PI/segments.length;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let i=0;i<segments.length;i++){
    const start = angle + i*arc - Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,radius,start,start+arc);
    ctx.fillStyle = colors[i];
    ctx.fill();

    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(start + arc/2);
    ctx.textAlign="right";
    ctx.fillStyle="#000";
    ctx.font="bold 28px Arial";
    ctx.fillText(segments[i].label, radius-20, 10);
    ctx.restore();
  }
}
drawWheel();

/* ================= BACKEND ================= */
async function api(path, body){
  const r = await fetch(BACKEND+path,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  return r.json();
}

async function init(){
  const res = await api("/api/auth",{ userId });
  points = res.user.points || 0;
  freeSpins = res.user.spinsLeft ?? 3;
  updateUI();
}
init();

/* ================= LOGIC ================= */
function pickIndex(){
  const total = segments.reduce((s,x)=>s+x.weight,0);
  let r = Math.random()*total;
  for(let i=0;i<segments.length;i++){
    if(r < segments[i].weight) return i;
    r -= segments[i].weight;
  }
  return 0;
}

document.getElementById("spinBtn").onclick = async ()=>{
  if(spinning) return;
  if(freeSpins<=0){ alert("Watch ad to get spin"); return; }

  freeSpins--;
  updateUI();
  spinning = true;

  const idx = pickIndex();
  const arc = 360/segments.length;
  const target = 360*5 + (360 - (idx*arc + arc/2));
  const start = performance.now(), duration = 4200;

  function anim(t){
    const p = Math.min(1,(t-start)/duration);
    angle = (target*(1-Math.pow(1-p,3))) * Math.PI/180;
    drawWheel();
    if(p<1) requestAnimationFrame(anim);
    else finish(idx);
  }
  requestAnimationFrame(anim);
};

async function finish(i){
  spinning=false;
  const seg = segments[i];

  if(seg.value==="free"){
    freeSpins++;
    alert("üéâ Free Spin!");
  }else if(seg.value>0){
    const r = await api("/save-points",{ userId, points:seg.value });
    points = r.points;
    alert("üéâ You won "+seg.value+" points");
  }else{
    alert("üòÖ Try Again");
  }
  updateUI();
}

/* ================= AD SYSTEM (30s REQUIRED) ================= */
document.getElementById("adBtn").onclick = async ()=>{
  try{
    const start = Date.now();
    await show_10302036('pop');
    const watched = (Date.now()-start)/1000;
    if(watched < 30){
      alert("‚ùå Watch full 30 seconds");
      return;
    }
    freeSpins++;
    await api("/api/watch_ad_verify",{ userId });
    alert("‚úÖ Ad completed! +1 spin");
    updateUI();
  }catch{
    alert("‚ùå Ad cancelled");
  }
};

function updateUI(){
  document.getElementById("points").innerText = points;
  document.getElementById("freeSpins").innerText = freeSpins;
}
</script>
</body>
</html>
