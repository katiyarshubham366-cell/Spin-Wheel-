<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spin & Win ‚Äî Cyber (Monetag integrated)</title>

<!-- Monetag SDK (Rewarded Popup) -->
<script src="//libtl.com/sdk.js" data-zone="10302036" data-sdk="show_10302036"></script>

<style>
:root{
  --bg-1:#030312; --bg-2:#071028; --muted:#9fb3c8;
  --neon-blue:#00d4ff; --neon-purple:#8b4dff;
  --wheel-size:320px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:
  radial-gradient(1200px 600px at 10% 10%, rgba(0,212,255,0.06), transparent 6%),
  linear-gradient(180deg,var(--bg-1),var(--bg-2)); color:#e6f7ff}
.wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.card{width:100%;max-width:420px;border-radius:16px;padding:18px;box-shadow:0 10px 40px rgba(0,0,0,0.7);
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.03)}
.hdr{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(90deg,var(--neon-blue),var(--neon-purple));
  display:flex;align-items:center;justify-content:center;font-weight:800;color:#04121a;font-size:18px;box-shadow:0 6px 18px rgba(139,77,255,0.12)}
.title{font-weight:700;font-size:16px}.sub{color:var(--muted);font-size:13px}
.pointsBox{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);font-weight:700}

/* wheel area */
.wheelArea{display:flex;flex-direction:column;align-items:center;margin-top:14px}

/* IMPORTANT: use --wheel-size variable so pointer positioning is exact */
.wheel-wrap{
  position:relative;
  width:var(--wheel-size);
  height:var(--wheel-size);
  margin:0 auto;
  border-radius:50%;
  box-shadow: 0 8px 30px rgba(0,0,0,0.5);
  overflow:visible;
  display:block;
}

/* outer subtle ring */
.wheel-wrap::before{
  content:""; position:absolute; inset:-8px; border-radius:50%;
  background:transparent; border:6px solid rgba(0,238,255,0.06); pointer-events:none;
  box-shadow: 0 0 18px rgba(0,212,255,0.04);
  animation: ringGlow 6s linear infinite;
}
@keyframes ringGlow{0%{filter:drop-shadow(0 0 6px rgba(0,212,255,0.06))}50%{filter:drop-shadow(0 0 22px rgba(0,212,255,0.12))}100%{filter:drop-shadow(0 0 6px rgba(0,212,255,0.06))}}

canvas#wheel{width:100%;height:100%;border-radius:50%;display:block;transform-origin:center center;}

/* ================= FIXED POINTER ================= */
.pointer{
  position:absolute;
  left:50%;
  top: calc(50% - (var(--wheel-size) / 2) - 6px);
  transform: translateX(-50%);
  width:0;height:0;
  border-left:18px solid transparent;
  border-right:18px solid transparent;
  border-bottom:34px solid var(--neon-blue);
  z-index:100;
  filter: drop-shadow(0 0 10px var(--neon-blue)) drop-shadow(0 0 18px var(--neon-purple));
  animation: pulseGlow 2s infinite ease-in-out;
  pointer-events:none;
}
@keyframes pulseGlow{0%{filter:drop-shadow(0 0 6px var(--neon-blue))}50%{filter:drop-shadow(0 0 18px var(--neon-blue))}100%{filter:drop-shadow(0 0 6px var(--neon-blue))}}

.pointer.shake{animation:pointerShake 0.28s ease-in-out 3}
@keyframes pointerShake{
  0%{transform:translateX(-50%) rotate(0)}
  25%{transform:translateX(calc(-50% - 3px)) rotate(-3deg)}
  50%{transform:translateX(-50%) rotate(0)}
  75%{transform:translateX(calc(-50% + 3px)) rotate(3deg)}
  100%{transform:translateX(-50%) rotate(0)}
}

/* center cap */
.wheel-center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:50;width:110px;height:110px;border-radius:50%;
  background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border:6px solid rgba(255,255,255,0.03);
  display:flex;align-items:center;justify-content:center;flex-direction:column;box-shadow:0 6px 18px rgba(139,77,255,0.06)}
.center-star{font-size:18px;color:var(--neon-blue);font-weight:800}.center-sub{font-size:12px;color:var(--muted)}

/* controls */
.controls{display:flex;gap:10px;justify-content:center;margin-top:14px}
.btn{padding:12px 16px;border-radius:12px;border:none;font-weight:800;cursor:pointer;box-shadow:0 8px 18px rgba(3,6,20,0.6)}
.btn-primary{background:linear-gradient(90deg,var(--neon-blue),var(--neon-purple));color:#04121a}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}

/* meta / leaderboard */
.meta{display:flex;justify-content:space-between;color:var(--muted);margin-top:12px;font-size:13px}
.leaderboard{margin-top:12px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));border-radius:10px;border:1px solid rgba(255,255,255,0.02);color:#cfe7ff;font-size:13px}

/* loading & welcome */
.loadingOverlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;background:linear-gradient(180deg, rgba(2,6,23,0.75), rgba(2,6,23,0.95));flex-direction:column;gap:16px}
.loader{width:92px;height:92px;border-radius:50%;background:conic-gradient(var(--neon-blue),var(--neon-purple),rgba(255,255,255,0.06));display:flex;align-items:center;justify-content:center;box-shadow:0 8px 30px rgba(139,77,255,0.12);animation:spin 1.2s linear infinite}
@keyframes spin{100%{transform:rotate(360deg)}}
.welcome{position:fixed;left:50%;transform:translateX(-50%);top:28px;z-index:999;background:linear-gradient(90deg, rgba(0,212,255,0.08), rgba(139,77,255,0.06));padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);font-weight:700;box-shadow:0 8px 18px rgba(0,0,0,0.6);opacity:0;transform-origin:center top;transition:all .6s cubic-bezier(.2,.9,.2,1)}
.welcome.show{opacity:1;transform:translateX(-50%) translateY(0)}

@media (max-width:380px){ :root{ --wheel-size:280px; } }
</style>
</head>
<body>
  <div id="loading" class="loadingOverlay" aria-hidden="false">
    <div class="loader" aria-hidden="true"></div>
    <div style="text-align:center">
      <div style="font-weight:800;font-size:18px">Loading Spin & Win</div>
      <div style="color:var(--muted);margin-top:6px">Connecting to Telegram & server...</div>
    </div>
  </div>

  <div id="welcome" class="welcome">Welcome</div>

  <div class="wrap">
    <div class="card" role="main">
      <div class="hdr">
        <div class="brand">
          <div class="logo">SW</div>
          <div>
            <div class="title">Spin & Win</div>
            <div class="sub">Neon Cyber ‚Ä¢ Earn Spins & Points</div>
          </div>
        </div>
        <div class="pointsBox">Points: <span id="points">0</span></div>
      </div>

      <div class="wheelArea">
        <div class="wheel-wrap" aria-hidden="false">
          <div class="pointer" aria-hidden="true"></div>
          <canvas id="wheel" width="600" height="600" role="img" aria-label="Prize wheel"></canvas>
          <div class="wheel-center">
            <div class="center-star">‚òÖ</div>
            <div class="center-sub small">Tap SPIN</div>
          </div>
        </div>

        <div class="controls">
          <button id="watchAd" class="btn btn-ghost">üé• Watch Ad (Get Spin)</button>
          <button id="spinBtn" class="btn btn-primary">SPIN</button>
        </div>

        <div class="meta">
          <div>Daily Spins Left: <b id="spinsLeft">0</b></div>
          <div class="small">Ad Spins: <b id="adTokens">0</b></div>
        </div>

        <div class="leaderboard" id="leaderboard">
          <div style="font-weight:700;margin-bottom:6px">üèÜ Leaderboard</div>
          <div id="lbRows">Loading‚Ä¶</div>
        </div>
      </div>
    </div>
  </div>

  <!-- sounds -->
  <audio id="spinSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_19df6f04e2.mp3?filename=wheel-spin-112941.mp3"></audio>
  <audio id="tickSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_4d8f7a7d4a.mp3?filename=ui-tick-6004.mp3"></audio>
  <audio id="winSound"  src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_f4f0e9c8b2.mp3?filename=success-1-6297.mp3"></audio>

<script>
/* CONFIG */
const BACKEND_BASE = "https://spin-backend-yzlk.onrender.com";
const FREE_SPINS_PER_DAY = 3;

/* Telegram WebApp */
const tg = window.Telegram?.WebApp;
if (tg) tg.expand();

const loadingEl = document.getElementById('loading');
const welcomeEl = document.getElementById('welcome');
const pointsEl = document.getElementById('points');
const spinsLeftEl = document.getElementById('spinsLeft');
const adTokensEl = document.getElementById('adTokens');
const lbRows = document.getElementById('lbRows');

const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const cw = canvas.width, ch = canvas.height, cx = cw/2, cy = ch/2;

const spinSound = document.getElementById('spinSound');
const tickSound = document.getElementById('tickSound');
const winSound = document.getElementById('winSound');

let user = null;
let isAnimating = false;
let adTokensLocal = 0;        // local ad tokens (in case backend not updated yet)

/* Prize setup */
const SEGMENTS = [
  {value:10, weight:20}, {value:15, weight:18}, {value:20, weight:15}, {value:25, weight:12},
  {value:30, weight:10}, {value:50, weight:7}, {value:55, weight:6}, {value:80, weight:5},
  {value:100, weight:4}, {value:150, weight:2}, {value:200, weight:1}
];
const COLORS = ["#0ff6ff","#6a6dff","#ff6ad5","#ffd166","#a4ffb8","#58b7ff","#c47bff","#ff7b7b","#ffe082","#8de0ff","#b39dff"];

/* draw */
function drawWheel(angleOffset=0){
  const n = SEGMENTS.length;
  const arc = (2*Math.PI)/n;
  ctx.clearRect(0,0,cw,ch);
  for(let i=0;i<n;i++){
    const start = i*arc + angleOffset;
    ctx.beginPath(); ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,cx,start,start+arc);
    ctx.closePath();
    ctx.fillStyle = COLORS[i%COLORS.length];
    ctx.fill();
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(start + arc/2);
    ctx.textAlign = "right"; ctx.fillStyle = "#04121a"; ctx.font = "bold 46px sans-serif";
    ctx.fillText(SEGMENTS[i].value+"", cx - 140, 18);
    ctx.restore();
  }
  ctx.beginPath(); ctx.arc(cx,cy,110,0,2*Math.PI); ctx.fillStyle="rgba(4,6,10,0.9)"; ctx.fill();
  ctx.beginPath(); ctx.arc(cx,cy,82,0,2*Math.PI); ctx.fillStyle="rgba(255,255,255,0.03)"; ctx.fill();
}
drawWheel();

/* API helper */
async function api(path, method='GET', body=null){
  try{
    const opts = { method, headers:{'Content-Type':'application/json'} };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(BACKEND_BASE + path, opts);
    return await res.json();
  }catch(e){
    console.warn('API error', e);
    return { ok:false, error:'network' };
  }
}

/* init */
async function init(){
  showLoading(true);
  const initData = tg ? tg.initData : null;
  const authResp = await api('/api/auth','POST',{ initData });
  if (authResp && authResp.ok) user = authResp.user;
  else user = { id: 'guest-' + Math.random().toString(36).slice(2,8), name:'Guest', points:0, spinsLeft:FREE_SPINS_PER_DAY, adTokens:0 };
  updateUI();
  loadLeaderboard();
  showLoading(false);
  showWelcome();
}
function updateUI(){
  pointsEl.innerText = user.points ?? 0;
  spinsLeftEl.innerText = user.spinsLeft ?? 0;
  // show adTokens: prefer backend value then local pending
  adTokensEl.innerText = (user.adTokens ?? 0) + (adTokensLocal || 0);
}

/* leaderboard */
async function loadLeaderboard(){
  const r = await api('/api/leaderboard','GET');
  lbRows.innerHTML = '';
  if (Array.isArray(r)) r.slice(0,6).forEach(u=>{ const row=document.createElement('div'); row.style.padding='6px 0'; row.innerText = `${u.name||u.id}: ${u.points} pts`; lbRows.appendChild(row);});
  else lbRows.innerText = "No data";
}

/* spin flow - server preferred */
document.getElementById('spinBtn').addEventListener('click', async ()=>{
  if (isAnimating) return;
  if (((user.spinsLeft ?? 0) <= 0) && ((user.adTokens ?? 0) + (adTokensLocal||0) <= 0)) { alert('No spins left today. Watch an ad to earn one.'); return; }

  // attempt server-side spin
  const serverResp = await api('/api/spin','POST',{ userId: user.id });
  if (serverResp && serverResp.ok) {
    animateTo(serverResp.index, ()=> {
      winSound.currentTime=0; winSound.play();
      user = serverResp.user; updateUI(); loadLeaderboard();
      shakePointer();
      setTimeout(()=> alert(`üéâ You won ${serverResp.prize} points!`), 200);
    });
    return;
  }

  // fallback local consume
  if ((user.spinsLeft || 0) > 0) user.spinsLeft--; else {
    // consume local ad token if backend hasn't updated yet
    if (user.adTokens > 0) user.adTokens--;
    else if (adTokensLocal > 0) adTokensLocal--;
    else { alert('No spins left'); return; }
  }
  updateUI();
  await api('/add-spin','POST', { userId: user.id });

  const idx = weightedPickIndex();
  animateTo(idx, async ()=> {
    const prize = SEGMENTS[idx].value;
    winSound.currentTime=0; winSound.play();
    const save = await api('/save-points','POST', { userId: user.id, points: prize });
    if (save && save.points !== undefined) user.points = save.points; else user.points = (user.points||0)+prize;
    updateUI(); loadLeaderboard(); shakePointer();
    setTimeout(()=> alert(`üéâ You won ${prize} points!`), 200);
  });
});

/* Watch ad ‚Äî Monetag rewarded popup integration */
const watchAdBtn = document.getElementById('watchAd');
let adInProgress = false;
watchAdBtn.addEventListener('click', async () => {
  if (adInProgress) return;
  adInProgress = true;
  watchAdBtn.disabled = true;
  watchAdBtn.textContent = 'Opening ad...';

  // Use Monetag SDK show_10302036('pop') ‚Äî provided by SDK script
  // If Monetag SDK isn't loaded or show_10302036 is not available, fallback to backend reward-ad page
  try {
    if (typeof show_10302036 === 'function') {
      await show_10302036('pop'); // show rewarded popup
      // success ‚Äî user watched ad fully (or provider reported completion)
      // credit local ad token immediately for instant UX
      adTokensLocal = (adTokensLocal || 0) + 1;
      updateUI();
      // notify backend so server also credits user (server should verify with provider in prod)
      api('/api/watch_ad_verify','POST',{ userId: user.id, providerToken: 'monetag-popup' })
        .then(resp => {
          // if backend returns ok and updated adTokens, merge
          if (resp && resp.ok && resp.user && resp.user.adTokens !== undefined) {
            // sync authoritative server value
            user.adTokens = resp.user.adTokens;
            adTokensLocal = 0;
            updateUI();
            loadLeaderboard();
          }
        }).catch(()=>{/* ignore network error ‚Äî UI already credited locally */});
      alert('üéâ Thanks! You earned 1 spin.');
    } else {
      // SDK not found ‚Äî fallback to external reward page
      const fallbackUrl = `${BACKEND_BASE}/reward-ad?userId=${encodeURIComponent(user.id)}`;
      if (tg && tg.openLink) tg.openLink(fallbackUrl); else window.open(fallbackUrl,'_blank');
      alert('Ad opened in external browser. After watching, the server will credit a spin.');
    }
  } catch (e) {
    console.warn('Ad error or closed by user', e);
    alert('Ad not completed or failed. No spin awarded.');
  } finally {
    adInProgress = false;
    watchAdBtn.disabled = false;
    watchAdBtn.textContent = 'üé• Watch Ad (Get Spin)';
  }
});

/* Helpers: weighted index, animate, pointer shake */
function weightedPickIndex(){ const total = SEGMENTS.reduce((s,x)=>s+x.weight,0); let r=Math.random()*total; for(let i=0;i<SEGMENTS.length;i++){ if(r<SEGMENTS[i].weight) return i; r-=SEGMENTS[i].weight } return SEGMENTS.length-1; }

function animateTo(targetIndex, onComplete){
  if (isAnimating) return;
  isAnimating = true;
  const n = SEGMENTS.length;
  const arc = 360 / n;
  const targetDeg = 90 - (targetIndex * arc + arc/2);
  const spins = 5 + Math.floor(Math.random()*3);
  const final = spins*360 + targetDeg;
  const duration = 4200;
  const start = performance.now();
  spinSound.currentTime = 0; spinSound.play();
  let lastTick = -1;
  function frame(now){
    const t = Math.min(1,(now - start)/duration);
    const eased = 1 - Math.pow(1 - t, 3);
    const deg = final * eased;
    canvas.style.transform = `rotate(${deg}deg)`;
    const tickCount = Math.floor((eased * spins * n));
    if (tickCount !== lastTick){ tickSound.currentTime = 0; tickSound.play(); lastTick = tickCount; }
    if (t < 1) requestAnimationFrame(frame);
    else { isAnimating = false; canvas.style.transform = `rotate(${final}deg)`; onComplete && onComplete(); }
  }
  requestAnimationFrame(frame);
}

function shakePointer(){ const p=document.querySelector('.pointer'); if(!p) return; p.classList.add('shake'); setTimeout(()=>p.classList.remove('shake'),900) }

function showLoading(show){ loadingEl.style.display = show ? 'flex' : 'none' }
function showWelcome(){ const name = user?.name || (tg?.initDataUnsafe?.user?.first_name) || 'Player'; welcomeEl.textContent = `Welcome, ${name}`; welcomeEl.classList.add('show'); setTimeout(()=> welcomeEl.classList.remove('show'),4200) }

/* start */
init();
</script>
</body>
</html>
