<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spin & Win ‚Äî Cyber</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  /* ====== cyber theme variables ====== */
  :root{
    --bg-1: #030312;
    --bg-2: #071028;
    --card: rgba(12,18,30,0.7);
    --glass: rgba(255,255,255,0.04);
    --neon-blue: #00d4ff;
    --neon-purple: #8b4dff;
    --accent: linear-gradient(90deg,var(--neon-blue),var(--neon-purple));
    --muted: #9fb3c8;
  }

  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Arial; background: radial-gradient(1200px 600px at 10% 10%, rgba(0, 212, 255, 0.06), transparent 6%), linear-gradient(180deg,var(--bg-1),var(--bg-2)); color:#e6f7ff}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
  .card{
    width:100%; max-width:420px; border-radius:16px; padding:18px; box-shadow: 0 10px 40px rgba(0,0,0,0.7);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); border:1px solid rgba(255,255,255,0.03);
    position:relative; overflow:hidden;
  }

  /* header */
  .hdr{display:flex;align-items:center;justify-content:space-between; gap:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{
    width:48px;height:48px;border-radius:10px; background:var(--accent); display:flex;align-items:center;justify-content:center;
    box-shadow: 0 6px 18px rgba(139,77,255,0.12), 0 3px 6px rgba(0,212,255,0.06);
    font-weight:800; color:#04121a; font-size:18px;
  }
  .title{font-weight:700;font-size:16px}
  .sub{color:var(--muted); font-size:13px}

  /* points box */
  .pointsBox{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); font-weight:700}

  /* wheel area */
  .wheelArea{display:flex;flex-direction:column;align-items:center;margin-top:14px}
  .wheel-wrap{position:relative;width:320px;height:320px}
  canvas#wheel{width:100%;height:100%;border-radius:50%;box-shadow: inset 0 -8px 24px rgba(0,0,0,0.6), 0 8px 30px rgba(0,0,0,0.5); transition: transform 0s; transform-origin:center center; }
  .pointer{
    position:absolute; left:50%; transform:translateX(-50%); top:-22px; z-index:30;
    width:0;height:0;border-left:20px solid transparent;border-right:20px solid transparent;border-bottom:36px solid #fff;
    filter: drop-shadow(0 6px 10px rgba(0,0,0,0.6));
  }
  .wheel-center{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); z-index:20;
    width:110px;height:110px;border-radius:50%; background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border:6px solid rgba(255,255,255,0.03);
    display:flex;align-items:center;justify-content:center; flex-direction:column;
    box-shadow: 0 6px 18px rgba(139,77,255,0.06), inset 0 -6px 24px rgba(0,0,0,0.6);
  }
  .center-star{font-size:18px;font-weight:800;color:var(--neon-blue)}
  .center-sub{font-size:12px;color:var(--muted)}

  /* controls */
  .controls{display:flex;gap:10px;justify-content:center;margin-top:14px}
  .btn{padding:12px 16px;border-radius:12px;border:none;font-weight:800;cursor:pointer;box-shadow:0 8px 18px rgba(3,6,20,0.6)}
  .btn-primary{background:linear-gradient(90deg,#00d4ff,#8b4dff); color:#04121a}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06); color:var(--muted)}

  /* meta */
  .meta{display:flex;justify-content:space-between;color:var(--muted);margin-top:12px;font-size:13px}
  .leaderboard{margin-top:12px;padding:10px;background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01)); border-radius:10px; border:1px solid rgba(255,255,255,0.02); color:#cfe7ff; font-size:13px}

  /* Loading overlay */
  .loadingOverlay{
    position:fixed; inset:0; display:flex;align-items:center;justify-content:center; z-index:9999;
    background: linear-gradient(180deg, rgba(2,6,23,0.7), rgba(2,6,23,0.9));
    color:#fff; flex-direction:column; gap:16px;
  }
  .loader{
    width:92px;height:92px;border-radius:50%;
    background: conic-gradient(var(--neon-blue), var(--neon-purple), rgba(255,255,255,0.06));
    display:flex;align-items:center;justify-content:center; box-shadow: 0 8px 30px rgba(139,77,255,0.12);
    animation: spin 1.2s linear infinite;
  }
  @keyframes spin{100%{transform: rotate(360deg)}}

  .welcome{
    position:fixed; left:50%; transform:translateX(-50%); top:28px; z-index:999;
    background: linear-gradient(90deg, rgba(0,212,255,0.08), rgba(139,77,255,0.06)); padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03); font-weight:700;
    box-shadow:0 8px 18px rgba(0,0,0,0.6); opacity:0; transform-origin:center top; transition:all .6s cubic-bezier(.2,.9,.2,1);
  }
  .welcome.show{opacity:1; transform:translateX(-50%) translateY(0);}

  /* responsive small */
  @media (max-width:360px){
    .wheel-wrap{width:280px;height:280px}
  }
</style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loading" class="loadingOverlay" aria-hidden="false">
    <div class="loader" aria-hidden="true"></div>
    <div style="text-align:center">
      <div style="font-weight:800;font-size:18px">Loading Spin & Win</div>
      <div style="color:var(--muted);margin-top:6px">Connecting to Telegram & server...</div>
    </div>
  </div>

  <!-- Welcome toast -->
  <div id="welcome" class="welcome">Welcome</div>

  <div class="wrap">
    <div class="card" role="main">
      <div class="hdr">
        <div class="brand">
          <div class="logo">SW</div>
          <div>
            <div class="title">Spin & Win</div>
            <div class="sub">Neon Cyber ‚Ä¢ Earn Spins & Points</div>
          </div>
        </div>
        <div class="pointsBox">Points: <span id="points">0</span></div>
      </div>

      <div class="wheelArea">
        <div class="wheel-wrap" aria-hidden="false">
          <div class="pointer" aria-hidden="true"></div>
          <canvas id="wheel" width="600" height="600" role="img" aria-label="Prize wheel"></canvas>

          <div class="wheel-center">
            <div class="center-star">‚òÖ</div>
            <div class="center-sub small">Tap SPIN</div>
          </div>
        </div>

        <div class="controls">
          <button id="watchAd" class="btn btn-ghost">üé• Watch Ad (Get Spin)</button>
          <button id="spinBtn" class="btn btn-primary">SPIN</button>
        </div>

        <div class="meta">
          <div>Daily Spins Left: <b id="spinsLeft">0</b></div>
          <div class="small">Ad Spins: <b id="adTokens">0</b></div>
        </div>

        <div class="leaderboard" id="leaderboard">
          <div style="font-weight:700;margin-bottom:6px">üèÜ Leaderboard</div>
          <div id="lbRows">Loading‚Ä¶</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sounds -->
  <audio id="spinSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_19df6f04e2.mp3?filename=wheel-spin-112941.mp3"></audio>
  <audio id="tickSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_4d8f7a7d4a.mp3?filename=ui-tick-6004.mp3"></audio>
  <audio id="winSound"  src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_f4f0e9c8b2.mp3?filename=success-1-6297.mp3"></audio>

<script>
/* ==========================
   CONFIG ‚Äî EDIT IF NEEDED
   ========================== */
const BACKEND_BASE = "https://spin-backend-yzlk.onrender.com"; // your backend
const FREE_SPINS_PER_DAY = 3;
const POLL_AD_MS = 3500; // poll interval after ad page opened
/* ========================== */

const tg = window.Telegram?.WebApp;
if (tg) tg.expand();

const loadingEl = document.getElementById('loading');
const welcomeEl = document.getElementById('welcome');
const pointsEl = document.getElementById('points');
const spinsLeftEl = document.getElementById('spinsLeft');
const adTokensEl = document.getElementById('adTokens');
const lbRows = document.getElementById('lbRows');

const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const cw = canvas.width, ch = canvas.height, cx = cw/2, cy = ch/2;

const spinSound = document.getElementById('spinSound');
const tickSound = document.getElementById('tickSound');
const winSound = document.getElementById('winSound');

let user = null;
let isAnimating = false;
let adPollInterval = null;

/* Prize table: must match server order if server-side used */
const SEGMENTS = [
  {value:10, weight:20}, {value:15, weight:18}, {value:20, weight:15}, {value:25, weight:12},
  {value:30, weight:10}, {value:50, weight:7}, {value:55, weight:6}, {value:80, weight:5},
  {value:100, weight:4}, {value:150, weight:2}, {value:200, weight:1}
];
const COLORS = ["#0ff6ff","#6a6dff","#ff6ad5","#ffd166","#a4ffb8","#58b7ff","#c47bff","#ff7b7b","#ffe082","#8de0ff","#b39dff"];

/* ---------------- draw wheel ---------------- */
function drawWheel(angleOffset=0){
  const n = SEGMENTS.length;
  const arc = (2*Math.PI)/n;
  ctx.clearRect(0,0,cw,ch);
  for(let i=0;i<n;i++){
    const start = i*arc + angleOffset;
    ctx.beginPath(); ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,cx,start,start+arc);
    ctx.closePath();
    ctx.fillStyle = COLORS[i%COLORS.length];
    ctx.fill();
    // label
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(start + arc/2);
    ctx.textAlign = "right"; ctx.fillStyle = "#04121a"; ctx.font = "bold 46px sans-serif";
    ctx.fillText(SEGMENTS[i].value+"", cx - 140, 18);
    ctx.restore();
  }
  // center
  ctx.beginPath(); ctx.arc(cx,cy,110,0,2*Math.PI); ctx.fillStyle="rgba(4,6,10,0.9)"; ctx.fill();
  ctx.beginPath(); ctx.arc(cx,cy,82,0,2*Math.PI); ctx.fillStyle="rgba(255,255,255,0.03)"; ctx.fill();
}
drawWheel();

/* ---------------- API helpers ---------------- */
async function api(path, method='GET', body=null){
  try{
    const opts = { method, headers:{'Content-Type':'application/json'} };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(BACKEND_BASE + path, opts);
    return await res.json();
  }catch(e){
    console.warn('API error', e);
    return { ok:false, error:'network' };
  }
}

/* ---------------- Init user & UI ---------------- */
async function init(){
  showLoading(true);
  // get initData from Telegram (if present) and authenticate
  const initData = tg ? tg.initData : null;
  const authResp = await api('/api/auth','POST', { initData });
  if (authResp && authResp.ok){
    user = authResp.user;
  } else {
    // fallback: try to load guest or call /user with a guest id
    const guestId = 'guest-' + Math.random().toString(36).slice(2,8);
    user = { id: guestId, name: 'Guest', points: 0, spinsLeft: FREE_SPINS_PER_DAY, adTokens:0 };
  }
  updateUI();
  loadLeaderboard();
  showLoading(false);
  showWelcome();
}
function updateUI(){
  pointsEl.innerText = user.points ?? 0;
  spinsLeftEl.innerText = user.spinsLeft ?? 0;
  adTokensEl.innerText = user.adTokens ?? 0;
}

/* ---------------- Leaderboard ---------------- */
async function loadLeaderboard(){
  const r = await api('/api/leaderboard','GET');
  lbRows.innerHTML = '';
  if (Array.isArray(r)){
    r.slice(0,6).forEach(u=>{
      const row = document.createElement('div'); row.style.padding='6px 0';
      row.innerText = `${u.name || u.id}: ${u.points} pts`;
      lbRows.appendChild(row);
    });
  } else {
    lbRows.innerText = "No data";
  }
}

/* ---------------- Spin flow (server-side would be better)
   We will request /add-spin to increase spin count only before spinning,
   then animate a client-side spin and call /save-points to persist result.
   If you later implement server-side spin (/api/spin) you can switch to that.
*/
document.getElementById('spinBtn').addEventListener('click', async ()=>{
  if (isAnimating) return;
  // check spins
  if ((user.spinsLeft || 0) <= 0 && (user.adTokens || 0) <= 0) {
    alert('No spins left today. Watch an ad to earn one.');
    return;
  }

  // consume either free spin or ad token locally first (server should validate too)
  if ((user.spinsLeft || 0) > 0) user.spinsLeft--;
  else user.adTokens--;

  updateUI();

  // inform backend: consume spin token (add-spin used here as demo)
  await api('/add-spin','POST', { userId: user.id });

  // choose prize index client-side using weighted distribution
  const idx = weightedPickIndex();
  animateTo(idx, async ()=>{
    const prize = SEGMENTS[idx].value;
    // play win sound
    winSound.currentTime = 0; winSound.play();
    // persist points to backend
    const resp = await api('/save-points','POST', { userId: user.id, points: prize });
    if (resp && resp.points !== undefined) {
      user.points = resp.points;
    } else {
      // fallback: local accumulate
      user.points = (user.points||0) + prize;
    }
    updateUI();
    loadLeaderboard();
    setTimeout(()=>{ alert(`üéâ You won ${prize} points!`); }, 200);
  });
});

/* ---------------- Watch ad flow ---------------- */
document.getElementById('watchAd').addEventListener('click', async ()=>{
  // open the backend's reward-ad page in external browser (needed for ad providers)
  const url = `${BACKEND_BASE}/reward-ad?userId=${encodeURIComponent(user.id)}`;
  if (tg && tg.openLink) tg.openLink(url); else window.open(url,'_blank');
  // start polling for ad verify credits
  startAdPoll();
  alert('Ad opened in new window. After completion your spin will be credited automatically.');
});

/* Poll server to see if ad gave tokens */
function startAdPoll(){
  if (adPollInterval) return;
  adPollInterval = setInterval(async ()=>{
    const r = await api('/api/user','POST', { userId: user.id });
    if (r && r.ok){
      const prev = user.adTokens || 0;
      user = r.user;
      updateUI();
      if ((user.adTokens || 0) > prev){
        clearInterval(adPollInterval);
        adPollInterval = null;
        alert('‚úÖ Ad finished ‚Äî you received +1 spin.');
      }
    }
  }, POLL_AD_MS);
}

/* ---------------- animation helpers ---------------- */
function weightedPickIndex(){
  const total = SEGMENTS.reduce((s,x)=>s+x.weight,0);
  let r = Math.random() * total;
  for (let i=0;i<SEGMENTS.length;i++){
    if (r < SEGMENTS[i].weight) return i;
    r -= SEGMENTS[i].weight;
  }
  return SEGMENTS.length - 1;
}

function animateTo(targetIndex, onComplete){
  if (isAnimating) return;
  isAnimating = true;
  const n = SEGMENTS.length;
  const arc = 360 / n;
  const targetDeg = 90 - (targetIndex * arc + arc/2);
  const spins = 5 + Math.floor(Math.random()*3);
  const final = spins*360 + targetDeg;
  const duration = 4200;
  const start = performance.now();
  spinSound.currentTime = 0; spinSound.play();

  let lastTick = -1;
  function frame(now){
    const t = Math.min(1,(now - start)/duration);
    const eased = 1 - Math.pow(1 - t, 3); // easeOutCubic
    const deg = final * eased;
    canvas.style.transform = `rotate(${deg}deg)`;

    // tick every slice passed
    const tickCount = Math.floor((eased * spins * n) );
    if (tickCount !== lastTick){
      tickSound.currentTime = 0; tickSound.play();
      lastTick = tickCount;
    }

    if (t < 1) requestAnimationFrame(frame);
    else {
      isAnimating = false;
      // leave wheel visually rotated to final
      canvas.style.transform = `rotate(${final}deg)`;
      onComplete && onComplete();
    }
  }
  requestAnimationFrame(frame);
}

/* ---------------- small helpers ---------------- */
function showLoading(show){
  loadingEl.style.display = show ? 'flex' : 'none';
}
function showWelcome(){
  const name = user?.name || (tg?.initDataUnsafe?.user?.first_name) || 'Player';
  welcomeEl.textContent = `Welcome, ${name}`;
  welcomeEl.classList.add('show');
  setTimeout(()=> welcomeEl.classList.remove('show'), 4200);
}

/* init on load */
init();

</script>
</body>
</html>
